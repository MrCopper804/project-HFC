<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFC Admin - Email System</title>
    <style>
        :root { --neon: #64ffda; --bg: #000; --admin: #ff0055; }
        body { background: var(--bg); color: white; font-family: sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: #0a0a0a; border: 1px solid #333; padding: 20px; border-radius: 20px; }
        .stat-box { background: rgba(100,255,218,0.1); padding: 10px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; border: 1px solid var(--neon); }
        .tab-btns { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: 1px solid #333; background: #111; color: #888; border-radius: 8px; cursor: pointer; }
        .tab-btn.active { background: var(--admin); color: white; border-color: var(--admin); }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #111; border: 1px solid #333; color: white; border-radius: 10px; box-sizing: border-box; }
        .send-btn { width: 100%; padding: 15px; background: var(--neon); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #status { margin-top: 15px; font-size: 12px; text-align: center; }
        .tracker { margin-top: 30px; border-top: 1px solid #222; padding-top: 20px; text-align: left; }
        .tracker h4 { color: var(--neon); font-size: 13px; }
        .read-list { font-size: 11px; color: #888; list-style: none; padding: 0; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color: var(--admin); text-align: center;">HFC MAIL CENTER</h2>
        
        <div class="stat-box">TOTAL REGISTERED AGENTS: <span id="totalUsersCount">0</span></div>

        <div class="tab-btns">
            <button id="btnSpecific" class="tab-btn active" onclick="switchTab('specific')">SPECIFIC USER</button>
            <button id="btnAll" class="tab-btn" onclick="switchTab('all')">ALL USERS</button>
        </div>

        <div id="emailField">
            <input type="email" id="targetEmail" placeholder="Enter Agent Email">
        </div>
        
        <textarea id="mailBody" rows="5" placeholder="Type your secure message..."></textarea>
        <button id="sendBtn" class="send-btn">TRANSMIT MESSAGE</button>
        
        <p id="status"></p>

        <div class="tracker">
            <h4>READ RECEIPTS (Active Tracking)</h4>
            <ul id="readReceipts" class="read-list"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, addDoc, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
            authDomain: "hfc-academy.firebaseapp.com",
            projectId: "hfc-academy",
            storageBucket: "hfc-academy.firebasestorage.app",
            messagingSenderId: "84006497196",
            appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentMode = 'specific';

        // --- Switch between Specific and All ---
        window.switchTab = (mode) => {
            currentMode = mode;
            document.getElementById('btnSpecific').className = mode === 'specific' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('btnAll').className = mode === 'all' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('emailField').style.display = mode === 'all' ? 'none' : 'block';
        };

        // --- Load Total Users ---
        async function loadStats() {
            const snap = await getDocs(collection(db, "users"));
            document.getElementById('totalUsersCount').innerText = snap.size;
        }

        // --- Real-time Read Tracker ---
        function startTracking() {
            const list = document.getElementById('readReceipts');
            const q = query(collection(db, "notifications"), orderBy("time", "desc"));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.read) {
                        list.innerHTML += `<li>âœ… [${data.toEmail || 'User'}] read your message</li>`;
                    }
                });
            });
        }

        // --- Send Logic ---
        document.getElementById('sendBtn').onclick = async () => {
            const emailInput = document.getElementById('targetEmail').value.trim().toLowerCase();
            const body = document.getElementById('mailBody').value.trim();
            const status = document.getElementById('status');

            if(!body) return alert("Message cannot be empty!");
            status.innerText = "Transmitting...";

            try {
                if(currentMode === 'specific') {
                    const q = query(collection(db, "users"), where("email", "==", emailInput));
                    const snap = await getDocs(q);
                    
                    if(!snap.empty) {
                        const userDoc = snap.docs[0];
                        await addDoc(collection(db, "notifications"), {
                            to: userDoc.id,
                            toEmail: emailInput,
                            text: body,
                            time: Date.now(),
                            read: false,
                            type: 'specific'
                        });
                        status.innerText = "CONFIRMED: Sent to " + emailInput;
                        status.style.color = "var(--neon)";
                    } else {
                        status.innerText = "ERROR: Agent Email Not Found!";
                        status.style.color = "red";
                    }
                } else {
                    // Send to All logic
                    await addDoc(collection(db, "notifications"), {
                        to: "ALL_USERS",
                        text: body,
                        time: Date.now(),
                        read: false,
                        type: 'broadcast'
                    });
                    status.innerText = "CONFIRMED: Broadcast Sent to All Agents!";
                    status.style.color = "var(--neon)";
                }
                document.getElementById('mailBody').value = "";
            } catch (e) {
                status.innerText = "System Failure: " + e.message;
            }
        };

        loadStats();
        startTracking();
    </script>
</body>
</html>
