<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC Academy - Cipher Tunnel</title>
    <style>
        :root { --neon: #64ffda; --bg: #000814; --danger: #ff4d4d; }
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg);
            color: white; overflow: hidden; height: 100vh;
        }

        /* Lobby Header */
        .header {
            height: 65px; background: rgba(10, 15, 26, 0.98); display: flex;
            align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            position: relative; z-index: 10;
        }
        .xp-val { color: var(--neon); font-weight: 900; margin-left: 10px; }

        #tunnel-container {
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
            perspective: 800px; background: radial-gradient(circle, #001d3d 0%, #000 100%);
        }

        .wall {
            position: absolute; width: 300px; height: 300px; border: 4px solid var(--neon);
            display: flex; justify-content: center; align-items: center; font-size: 80px;
            color: var(--neon); text-shadow: 0 0 20px var(--neon); background: rgba(100, 255, 218, 0.05);
            border-radius: 20px; transition: transform 0.1s linear; transform: translateZ(-1000px);
        }

        .ui-layer {
            position: absolute; inset: 0; z-index: 20; display: flex; flex-direction: column;
            justify-content: center; align-items: center; background: rgba(0,0,0,0.8);
        }

        .input-box {
            position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center;
        }
        input {
            width: 250px; padding: 15px; border-radius: 15px; border: 2px solid var(--neon);
            background: rgba(0,0,0,0.8); color: white; text-align: center; font-size: 24px; outline: none;
        }

        .btn-start { background: var(--neon); color: black; padding: 15px 40px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .score-ui { position: absolute; top: 80px; right: 20px; color: var(--neon); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <a href="lobby.html" style="text-decoration:none; font-size:24px;">üè†</a>
        <div class="xp-val">XP: <span id="userXP">--</span></div>
    </div>

    <div id="tunnel-container">
        </div>

    <div id="startMenu" class="ui-layer">
        <h1 style="color:var(--neon); letter-spacing:8px;">CIPHER TUNNEL</h1>
        <p>Fee: 50 XP | Reward: 150 XP</p>
        <button class="btn-start" onclick="initMission()">START MISSION</button>
    </div>

    <div id="gameOver" class="ui-layer" style="display:none;">
        <h1 style="color:var(--danger)">CRASHED!</h1>
        <button class="btn-start" onclick="location.reload()">RETRY</button>
    </div>

    <div class="score-ui" id="score">SCORE: 0/20</div>

    <div class="input-box">
        <input type="text" id="userInput" placeholder="DECODE..." autocomplete="off" disabled>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
        authDomain: "hfc-academy.firebaseapp.com",
        projectId: "hfc-academy",
        storageBucket: "hfc-academy.firebasestorage.app",
        messagingSenderId: "84006497196",
        appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const hfc = {'A':'+','B':'[]','C':'¬©','D':'√∑','E':'=','F':'_','G':'>','H':'|','I':'!','J':'#','K':':','L':'<','M':'*','N':'¬∞','O':'()','P':'¬∂','Q':'?','R':'¬Æ','S':'$','T':'‚Ñ¢','U':"'",'V':'^','W':'&','X':'`','Y':'~','Z':'‚ÑÖ'};
    
    let xp = 0, score = 0, currentWall = null, gameActive = false, posZ = -1000;

    onAuthStateChanged(auth, user => {
        if(user) onSnapshot(doc(db, "users", user.uid), snap => {
            xp = snap.data().score || 0;
            document.getElementById('userXP').innerText = xp;
        });
    });

    window.initMission = async () => {
        if(xp < 50) return alert("Low XP!");
        await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(-50) });
        
        document.getElementById('startMenu').style.display = 'none';
        document.getElementById('userInput').disabled = false;
        document.getElementById('userInput').focus();
        gameActive = true;
        spawnWall();
        animateTunnel();
    };

    function spawnWall() {
        if(!gameActive) return;
        const keys = Object.keys(hfc);
        const randKey = keys[Math.floor(Math.random()*keys.length)];
        
        const el = document.createElement('div');
        el.className = 'wall';
        el.innerText = hfc[randKey];
        document.getElementById('tunnel-container').appendChild(el);
        
        posZ = -1000;
        currentWall = { el, key: randKey };
    }

    function animateTunnel() {
        if(!gameActive) return;
        
        posZ += 8 + (score * 0.5); // Speed increases with score
        currentWall.el.style.transform = `translateZ(${posZ}px)`;

        if(posZ > 300) { // Crash!
            gameActive = false;
            document.getElementById('gameOver').style.display = 'flex';
        }

        requestAnimationFrame(animateTunnel);
    }

    document.getElementById('userInput').oninput = function() {
        if(!gameActive) return;
        if(this.value.toUpperCase() === currentWall.key) {
            currentWall.el.remove();
            score++;
            document.getElementById('score').innerText = `SCORE: ${score}/20`;
            this.value = "";
            
            if(score >= 20) {
                winMission();
            } else {
                spawnWall();
            }
        }
    };

    async function winMission() {
        gameActive = false;
        await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(150) });
        alert("TUNNEL CLEARED! +150 XP");
        location.reload();
    }
</script>
</body>
</html>
