<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC Academy - Turbo Tunnel</title>
    <style>
        :root { --neon: #64ffda; --bg: #000; --danger: #ff4d4d; --gold: #ffd700; }
        body { 
            margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg);
            color: white; overflow: hidden; height: 100vh;
        }

        .header {
            height: 65px; background: rgba(10, 15, 26, 0.98); display: flex;
            align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(100, 255, 218, 0.1);
            position: relative; z-index: 50;
        }
        .xp-val { color: var(--neon); font-weight: 900; margin-left: 10px; font-size: 14px; }

        #game-world {
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
            perspective: 1000px; background: #000; overflow: hidden;
        }

        .wall {
            position: absolute; width: 350px; height: 350px; border: 5px solid var(--neon);
            display: flex; justify-content: center; align-items: center; font-size: 100px;
            color: var(--neon); text-shadow: 0 0 30px var(--neon);
            background: rgba(100, 255, 218, 0.1); border-radius: 30px;
            transform: translateZ(-1500px);
        }

        .ui-overlay {
            position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }

        .input-container {
            position: absolute; bottom: 50px; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 60;
        }
        input {
            width: 200px; padding: 15px; border-radius: 20px; border: 3px solid var(--neon);
            background: rgba(0,0,0,0.9); color: white; text-align: center; font-size: 30px; 
            font-weight: bold; outline: none;
        }

        .btn-start { background: var(--neon); color: black; padding: 18px 50px; border: none; border-radius: 15px; font-weight: 900; cursor: pointer; }
        .score-display { position: absolute; top: 85px; left: 20px; color: var(--gold); font-weight: 900; z-index: 60; }
        
        .rank-lock { color: var(--danger); font-size: 12px; margin-top: 10px; font-weight: bold; }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-3px, 2px); }
            100% { transform: translate(1px, -2px); }
        }
        .shake-active { animation: shake 0.2s infinite; }
    </style>
</head>
<body>

    <div class="header">
        <a href="lobby.html" style="text-decoration:none; font-size:24px;">üè†</a>
        <div class="xp-val">XP: <span id="headerXP">--</span></div>
    </div>

    <div id="game-world"></div>
    <div class="score-display" id="scoreBoard">CLEARANCE: 0/5</div>

    <div id="startMenu" class="ui-overlay">
        <h1 style="color:var(--neon); letter-spacing: 5px;">TURBO TUNNEL</h1>
        <p style="font-size: 12px; margin-bottom: 20px;">FEE: 50 XP | REWARD: 150 XP</p>
        
        <div id="rankCheckArea">
            <p style="color:#666">Verifying Rank...</p>
        </div>
    </div>

    <div id="deathScreen" class="ui-overlay" style="display:none;">
        <h1 style="color:var(--danger)">IMPACT DETECTED</h1>
        <button class="btn-start" onclick="location.reload()">RE-TRY</button>
    </div>

    <div class="input-container">
        <input type="text" id="userInput" maxlength="1" autocomplete="off" disabled>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
        authDomain: "hfc-academy.firebaseapp.com",
        projectId: "hfc-academy",
        storageBucket: "hfc-academy.firebasestorage.app",
        messagingSenderId: "84006497196",
        appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const hfc = {'A':'+','B':'[]','C':'¬©','D':'√∑','E':'=','F':'_','G':'>','H':'|','I':'!','J':'#','K':':','L':'<','M':'*','N':'¬∞','O':'()','P':'¬∂','Q':'?','R':'¬Æ','S':'$','T':'‚Ñ¢','U':"'",'V':'^','W':'&','X':'`','Y':'~','Z':'‚ÑÖ'};
    const rankHierarchy = ['recruit', 'agent', 'operative', 'specialist', 'analyst', 'assassin', 'elite', 'commander', 'ghost', 'legend'];

    let xp = 0, userRank = 'recruit', solved = 0, gameActive = false, zPos = -1500, currentWall = null;

    onAuthStateChanged(auth, user => {
        if(user) onSnapshot(doc(db, "users", user.uid), snap => {
            const data = snap.data();
            xp = data.score || 0;
            userRank = data.rank || 'recruit';
            document.getElementById('headerXP').innerText = xp;
            checkRankAccess();
        });
    });

    function checkRankAccess() {
        const rankIndex = rankHierarchy.indexOf(userRank);
        const area = document.getElementById('rankCheckArea');
        if(rankIndex >= 2) { 
            area.innerHTML = `<button class="btn-start" onclick="launchMission()">START MISSION</button>`;
        } else {
            area.innerHTML = `<p class="rank-lock">ACCESS DENIED: ${userRank.toUpperCase()}<br>OPERATIVE CLEARANCE REQUIRED</p>`;
        }
    }

    window.launchMission = async () => {
        if(xp < 50) return alert("Insufficient XP!");
        await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(-50) });
        document.getElementById('startMenu').style.display = 'none';
        document.getElementById('userInput').disabled = false;
        document.getElementById('userInput').focus();
        gameActive = true;
        spawnWall();
        runEngine();
    };

    function spawnWall() {
        if(!gameActive) return;
        const keys = Object.keys(hfc);
        const rand = keys[Math.floor(Math.random()*keys.length)];
        const el = document.createElement('div');
        el.className = 'wall';
        el.innerText = hfc[rand];
        document.getElementById('game-world').appendChild(el);
        zPos = -1500;
        currentWall = { el, key: rand };
    }

    function runEngine() {
        if(!gameActive) return;
        zPos += 14 + (solved * 2); // Speed increases with each wall
        currentWall.el.style.transform = `translateZ(${zPos}px)`;

        if(zPos > -400) document.body.classList.add('shake-active');
        else document.body.classList.remove('shake-active');

        if(zPos > 250) {
            gameActive = false;
            document.body.classList.remove('shake-active');
            document.getElementById('deathScreen').style.display = 'flex';
        }
        requestAnimationFrame(runEngine);
    }

    document.getElementById('userInput').oninput = function() {
        if(!gameActive) return;
        if(this.value.toUpperCase() === currentWall.key) {
            currentWall.el.remove();
            solved++;
            document.getElementById('scoreBoard').innerText = `CLEARANCE: ${solved}/5`;
            this.value = "";
            if(solved >= 5) win();
            else spawnWall();
        }
    };

    async function win() {
        gameActive = false;
        await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(150) });
        alert("TUNNEL CLEARED! +150 XP AWARDED.");
        location.reload();
    }
</script>
</body>
</html>
