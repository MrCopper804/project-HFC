<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC 3D Ghost Decoder | Umair Khan</title>
    <style>
        :root { --neon: #64ffda; --danger: #ff4d4d; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        #game-ui { position: absolute; top: 0; width: 100%; padding: 20px; box-sizing: border-box; display: flex; justify-content: space-between; color: var(--neon); z-index: 10; pointer-events: none; }
        
        #decoding-zone { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; text-align: center; z-index: 20; }
        
        .symbol-bubble { font-size: 40px; color: #fff; text-shadow: 0 0 15px var(--neon); margin-bottom: 10px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 50%; border: 2px solid var(--neon); display: inline-block; width: 60px; height: 60px; line-height: 60px; }
        
        input { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid var(--neon); background: rgba(10, 25, 47, 0.9); color: #fff; font-size: 18px; text-align: center; pointer-events: auto; outline: none; }
        
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 100; color: white; text-align: center; }
        .btn-start { background: var(--neon); color: #000; border: none; padding: 15px 40px; font-weight: bold; border-radius: 5px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="game-ui">
        <div>XP: <span id="xpDisplay">--</span></div>
        <div id="timer">60s</div>
    </div>

    <div id="overlay">
        <div>
            <h1 style="color:var(--neon)">HFC 3D DECODER</h1>
            <p>Entry: 50 XP | Reward: 150 XP</p>
            <p style="font-size: 12px; color: #888;">Decode the 3D falling symbols to survive.</p>
            <button class="btn-start" id="startBtn">START MISSION</button>
        </div>
    </div>

    <div id="decoding-zone" style="display:none;">
        <div class="symbol-bubble" id="currentSymbol">?</div>
        <input type="text" id="answerInput" placeholder="TYPE LETTER" autocomplete="off">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
            authDomain: "hfc-academy.firebaseapp.com",
            projectId: "hfc-academy",
            storageBucket: "hfc-academy.firebasestorage.app",
            messagingSenderId: "84006497196",
            appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const hfcData = {'A': '+', 'B': '[]', 'C': '©', 'D': '÷', 'E': '=', 'F': '_', 'G': '>', 'H': '|', 'I': '!', 'J': '#', 'K': ':', 'L': '<', 'M': '*', 'N': '°', 'O': '()', 'P': '¶', 'Q': '?', 'R': '®', 'S': '$', 'T': '™', 'U': "'", 'V': '^', 'W': '&', 'X': '`', 'Y': '~', 'Z': '℅'};
        
        let scene, camera, renderer, starField;
        let currentUser = null;
        let userXP = 0;
        let targetLetter = "";
        let gameActive = false;

        // --- Firebase Sync ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userXP = snap.data().score || 0;
                    document.getElementById('xpDisplay').innerText = userXP;
                });
            } else { window.location.href = "auth.html"; }
        });

        // --- 3D Background Setup ---
        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 5000; i++) {
                vertices.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0x64ffda, size: 2 });
            starField = new THREE.Points(geometry, material);
            scene.add(starField);
            camera.position.z = 5;
        }

        function animate() {
            requestAnimationFrame(animate);
            starField.rotation.y += 0.002;
            starField.rotation.z += 0.001;
            renderer.render(scene, camera);
        }

        // --- Game Logic ---
        async function startMission() {
            if (userXP < 50) return alert("Low XP!");
            const userRef = doc(db, "users", currentUser.uid);
            await updateDoc(userRef, { score: increment(-50) });

            document.getElementById('overlay').style.display = 'none';
            document.getElementById('decoding-zone').style.display = 'block';
            gameActive = true;
            nextSymbol();
        }

        function nextSymbol() {
            const letters = Object.keys(hfcData);
            targetLetter = letters[Math.floor(Math.random() * letters.length)];
            document.getElementById('currentSymbol').innerText = hfcData[targetLetter];
            document.getElementById('answerInput').value = "";
            document.getElementById('answerInput').focus();
        }

        document.getElementById('answerInput').oninput = async function(e) {
            if (this.value.toUpperCase() === targetLetter) {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { score: increment(5) }); // Small reward per letter
                nextSymbol();
            }
        };

        document.getElementById('startBtn').onclick = startMission;
        init3D();
        animate();
    </script>
</body>
</html>
