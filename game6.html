<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC Academy - Turbo Tunnel Rewards</title>
    <style>
        :root {
            --neon: #64ffda;
            --bg: #00050a;
            --danger: #ff4d4d;
            --glass: rgba(255, 255, 255, 0.03);
            --gold: #ffd700;
        }

        body { 
            margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg);
            color: white; overflow: hidden; height: 100vh;
        }

        /* HUD Display */
        .hud-header {
            position: absolute; top: 0; width: 100%; padding: 15px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; box-sizing: border-box;
        }

        .hud-card {
            background: var(--glass); border: 1px solid rgba(100, 255, 218, 0.2);
            padding: 10px 20px; border-radius: 15px; backdrop-filter: blur(10px);
        }

        .label { font-size: 9px; color: var(--neon); letter-spacing: 2px; font-weight: 800; display: block; }
        .value { font-size: 18px; font-weight: 900; color: #fff; text-shadow: 0 0 10px var(--neon); }

        /* Tunnel World */
        #game-container {
            position: absolute; inset: 0; perspective: 1000px;
            background: radial-gradient(circle at center, #112240 0%, #000 80%);
            display: flex; justify-content: center; align-items: center;
        }

        .wall {
            position: absolute; width: 320px; height: 320px;
            border: 2px solid var(--neon); border-radius: 20px;
            background: linear-gradient(45deg, rgba(100, 255, 218, 0.05), transparent);
            box-shadow: 0 0 40px rgba(100, 255, 218, 0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 120px; font-weight: 900; color: #fff;
            text-shadow: 0 0 30px var(--neon); transform: translateZ(-1500px);
        }

        .overlay {
            position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        .menu-box {
            background: var(--glass); border: 1px solid var(--neon);
            padding: 40px; border-radius: 30px; text-align: center; width: 80%; max-width: 350px;
        }

        .btn-prime {
            background: var(--neon); color: #000; border: none; padding: 15px 40px;
            border-radius: 12px; font-weight: 900; cursor: pointer; width: 100%;
        }

        .input-hud {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            z-index: 100;
        }

        #userInput {
            width: 80px; height: 80px; background: rgba(0,0,0,0.8);
            border: 3px solid var(--neon); border-radius: 20px; color: white;
            font-size: 40px; font-weight: 900; text-align: center; outline: none;
        }

        #reward-pop {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            color: var(--gold); font-weight: 900; font-size: 24px; display: none;
            z-index: 150; text-shadow: 0 0 20px var(--gold);
        }
    </style>
</head>
<body>

    <div id="reward-pop">+150 XP CHECKPOINT!</div>

    <div class="hud-header">
        <div class="hud-card">
            <span class="label">WALLS BREACHED</span>
            <span class="value" id="scoreUI">0</span>
        </div>
        <div class="hud-card">
            <span class="label">WALLET XP</span>
            <span class="value" id="xpUI">0</span>
        </div>
    </div>

    <div id="game-container"></div>

    <div id="startMenu" class="overlay">
        <div class="menu-box">
            <h1 style="color:var(--neon); letter-spacing:5px;">REWARD TUNNEL</h1>
            <p style="font-size:10px; color:#888; margin-bottom:30px;">FEE: 50 XP | REWARD: +150 XP EVERY 5 WALLS</p>
            <div id="authArea"><p>Checking Clearance...</p></div>
        </div>
    </div>

    <div id="deathMenu" class="overlay" style="display:none;">
        <div class="menu-box" style="border-color:var(--danger)">
            <h1 style="color:var(--danger)">CRASHED</h1>
            <p id="finalStat" style="font-size:12px; margin:20px 0;"></p>
            <button class="btn-prime" style="background:var(--danger)" onclick="location.reload()">RE-TRY</button>
            <a href="lobby.html" style="color:#555; font-size:10px; margin-top:20px; display:block; text-decoration:none;">EXIT MISSION</a>
        </div>
    </div>

    <div class="input-hud">
        <input type="text" id="userInput" maxlength="1" autocomplete="off" disabled>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
        authDomain: "hfc-academy.firebaseapp.com",
        projectId: "hfc-academy",
        storageBucket: "hfc-academy.firebasestorage.app",
        messagingSenderId: "84006497196",
        appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const hfc = {'A':'+','B':'[]','C':'©','D':'÷','E':'=','F':'_','G':'>','H':'|','I':'!','J':'#','K':':','L':'<','M':'*','N':'°','O':'()','P':'¶','Q':'?','R':'®','S':'$','T':'™','U':"'",'V':'^','W':'&','X':'`','Y':'~','Z':'℅'};
    const ranks = ['recruit', 'agent', 'operative', 'specialist', 'analyst', 'assassin', 'elite', 'commander', 'ghost', 'legend'];

    let currentXP = 0, userRank = 'recruit', solved = 0, checkpointCounter = 0, z = -1500, gameActive = false, currentWall = null;

    onAuthStateChanged(auth, user => {
        if(user) onSnapshot(doc(db, "users", user.uid), snap => {
            const data = snap.data();
            currentXP = data.score || 0;
            userRank = data.rank || 'recruit';
            document.getElementById('xpUI').innerText = currentXP;
            
            const authArea = document.getElementById('authArea');
            if(ranks.indexOf(userRank) >= 2) {
                authArea.innerHTML = `<button class="btn-prime" onclick="startMission()">START MISSION (-50 XP)</button>`;
            } else {
                authArea.innerHTML = `<p style="color:var(--danger); font-weight:bold;">OPERATIVE CLEARANCE REQUIRED</p>`;
            }
        });
    });

    window.startMission = async () => {
        if(currentXP < 50) return alert("Low XP!");
        await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(-50) });
        
        document.getElementById('startMenu').style.display = 'none';
        document.getElementById('userInput').disabled = false;
        document.getElementById('userInput').focus();
        gameActive = true;
        spawn();
        loop();
    };

    function spawn() {
        if(!gameActive) return;
        const keys = Object.keys(hfc);
        const k = keys[Math.floor(Math.random()*keys.length)];
        const el = document.createElement('div');
        el.className = 'wall';
        el.innerText = hfc[k];
        document.getElementById('game-container').appendChild(el);
        z = -1500;
        currentWall = { el, k };
    }

    function loop() {
        if(!gameActive) return;
        z += 17 + (solved * 1.2); 
        currentWall.el.style.transform = `translateZ(${z}px)`;

        if(z > 200) {
            endGame("IMPACT DETECTED");
        }
        requestAnimationFrame(loop);
    }

    document.getElementById('userInput').oninput = async function() {
        if(this.value.toUpperCase() === currentWall.k) {
            currentWall.el.remove();
            solved++;
            checkpointCounter++;
            document.getElementById('scoreUI').innerText = solved;
            this.value = "";
            
            // Reward every 5 walls
            if(checkpointCounter === 5) {
                checkpointCounter = 0;
                await updateDoc(doc(db, "users", auth.currentUser.uid), { score: increment(150) });
                showRewardPop();
            }
            
            spawn();
        } else if(this.value.length > 0) {
            endGame("DECODE ERROR");
        }
    };

    function showRewardPop() {
        const pop = document.getElementById('reward-pop');
        pop.style.display = 'block';
        setTimeout(() => pop.style.display = 'none', 1500);
    }

    async function endGame(reason) {
        gameActive = false;
        document.getElementById('userInput').disabled = true;
        document.getElementById('deathMenu').style.display = 'flex';
        document.getElementById('finalStat').innerText = `${reason}\nTOTAL WALLS BREACHED: ${solved}`;
    }
</script>
</body>
</html>
