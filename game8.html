<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC - Coin Flip Arena</title>
    <style>
        :root { --neon: #64ffda; --bg: #000; --gold: #ffd700; --glass: rgba(255, 255, 255, 0.05); --danger: #ff4d4d; }
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); 
            background-image: radial-gradient(circle at top, #112240 0%, #000 90%);
            color: white; margin: 0; padding: 15px; min-height: 100vh;
        }
        .wallet-card {
            background: rgba(100, 255, 218, 0.08); border: 1px solid var(--neon);
            padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.1);
        }
        .card { background: var(--glass); border: 1px solid #222; padding: 20px; border-radius: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        input, select { width: 100%; padding: 14px; margin: 10px 0; background: #000; border: 1px solid #333; color: white; border-radius: 10px; outline: none; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; background: var(--neon); color: #000; border: none; font-weight: 900; border-radius: 12px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        
        .cf-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; 
            margin-bottom: 10px; border: 1px solid #222;
        }
        .status-tag { font-size: 10px; color: var(--gold); font-weight: bold; border: 1px solid var(--gold); padding: 2px 8px; border-radius: 4px; }
        
        #loader { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; font-weight: bold; color: var(--neon); letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="loader">INITIALIZING ARENA...</div>

    <div class="wallet-card">
        <span style="font-size: 10px; color: var(--neon); letter-spacing: 2px;">VAULT BALANCE</span>
        <div id="balanceDisplay" style="font-size: 28px; font-weight: 900;">0</div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 15px 0; font-size:14px; color:var(--gold);">CREATE A CHALLENGE</h3>
        <input type="number" id="betInput" placeholder="Enter Bet Amount">
        <select id="sideInput">
            <option value="Heads">I Choose Heads</option>
            <option value="Tails">I Choose Tails</option>
        </select>
        <button class="btn" onclick="createFlip()">Deploy Battle</button>
    </div>

    <h4 style="letter-spacing: 2px; color: var(--neon); font-size: 12px; margin-left: 5px;">ACTIVE BATTLES</h4>
    <div id="flipList"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment, collection, addDoc, query, where, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
        authDomain: "hfc-academy.firebaseapp.com",
        projectId: "hfc-academy",
        storageBucket: "hfc-academy.firebasestorage.app",
        messagingSenderId: "84006497196",
        appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userCoins = 0;
    let currentUser = null;

    onAuthStateChanged(auth, u => {
        if(u) {
            currentUser = u;
            onSnapshot(doc(db, "users", u.uid), s => {
                userCoins = s.data().coins || 0;
                document.getElementById('balanceDisplay').innerText = userCoins;
                document.getElementById('loader').style.display = 'none';
            });
            listenToFlips();
        } else { window.location.href="auth.html"; }
    });

    // --- CREATE BATTLE ---
    window.createFlip = async () => {
        const bet = parseInt(document.getElementById('betInput').value);
        const side = document.getElementById('sideInput').value;
        if(!bet || bet < 1) return alert("Enter valid amount!");
        if(bet > userCoins) return alert("Insufficient coins!");

        try {
            await updateDoc(doc(db, "users", currentUser.uid), { coins: increment(-bet) });
            await addDoc(collection(db, "coinflips"), {
                creatorId: currentUser.uid,
                creatorName: currentUser.email.split('@')[0],
                betAmount: bet,
                creatorSide: side,
                status: "pending",
                timestamp: serverTimestamp()
            });
            document.getElementById('betInput').value = "";
            alert("Battle Deployed!");
        } catch (e) { alert("Error: " + e.message); }
    };

    // --- LIVE LISTENER (FIXED) ---
    function listenToFlips() {
        const q = query(collection(db, "coinflips"), where("status", "==", "pending"));
        
        onSnapshot(q, (snap) => {
            const list = document.getElementById('flipList');
            if(snap.empty) {
                list.innerHTML = "<p style='text-align:center; color:#444; font-size:12px;'>No active challenges found.</p>";
                return;
            }

            let flips = [];
            snap.forEach(d => flips.push({ id: d.id, ...d.data() }));

            // Manual Sort Newest First
            flips.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            list.innerHTML = "";
            flips.forEach(f => {
                const isMine = f.creatorId === currentUser.uid;
                list.innerHTML += `
                    <div class="cf-item" style="${isMine ? 'border-left: 3px solid var(--neon)' : ''}">
                        <div>
                            <b style="color:${isMine ? 'var(--neon)' : '#fff'}">${isMine ? 'YOUR BATTLE' : f.creatorName}</b><br>
                            <small style="color:var(--gold)">STAKE: ${f.betAmount} COINS</small>
                        </div>
                        ${isMine ? '<span class="status-tag">WAITING</span>' : 
                        `<button class="btn" style="padding:8px 15px; width:auto; font-size:10px;" onclick="joinFlip('${f.id}', ${f.betAmount})">PLAY</button>`}
                    </div>
                `;
            });
        });
    }

    // --- JOIN & WINNER LOGIC ---
    window.joinFlip = async (flipId, betAmount) => {
        if(userCoins < betAmount) return alert("You need more coins to join!");

        try {
            await runTransaction(db, async (transaction) => {
                const flipRef = doc(db, "coinflips", flipId);
                const flipSnap = await transaction.get(flipRef);
                const d = flipSnap.data();

                if(d.status !== "pending") throw "This battle is already over!";

                // Generate Secure Random Result
                const result = Math.random() < 0.5 ? "Heads" : "Tails";
                const winnerId = (d.creatorSide === result) ? d.creatorId : currentUser.uid;

                // Transactional Updates
                transaction.update(doc(db, "users", currentUser.uid), { coins: increment(-betAmount) });
                transaction.update(doc(db, "users", winnerId), { coins: increment(betAmount * 2) });
                transaction.update(flipRef, { 
                    status: "completed", 
                    winnerId: winnerId, 
                    result: result,
                    joinerId: currentUser.uid 
                });
            });
            alert("Battle Completed! Check your vault.");
        } catch (e) { alert("Join Error: " + e); }
    };
</script>
</body>
</html>
