<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC - Colorful Bubble Shooter</title>
    <style>
        :root { 
            --neon: #64ffda; 
            --bg: #030712; 
            --gold: #ffd700; 
            --danger: #ff4d4d;
            --purple: #bc13fe;
            --blue: #3d5afe;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; 
            margin: 0; overflow: hidden; text-align: center;
            background: linear-gradient(180deg, #050a18 0%, #000 100%);
        }
        .header { 
            position: absolute; top: 10px; width: 94%; left: 3%;
            display: flex; justify-content: space-between; font-size: 11px; 
            color: var(--neon); z-index: 10; border: 1px solid rgba(100, 255, 218, 0.3); 
            padding: 12px; border-radius: 12px; background: rgba(0,0,0,0.8);
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.1);
        }
        #menu-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .btn-start { 
            padding: 18px 40px; background: linear-gradient(45deg, var(--danger), #ff8e53); 
            color: #fff; border: none; border-radius: 50px; font-weight: 900; 
            cursor: pointer; text-transform: uppercase; box-shadow: 0 5px 20px rgba(255, 77, 77, 0.4);
        }
    </style>
</head>
<body>

    <div class="header">
        <span>AGENT: <b id="userRank" style="color: var(--purple);">LOADING...</b></span>
        <span>VAULT: <b id="userCoins" style="color: var(--gold);">0</b></span>
    </div>

    <div id="menu-overlay">
        <h1 style="background: linear-gradient(to right, #64ffda, #bc13fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 3rem; margin: 0;">NEON CIPHER</h1>
        <p id="msg" style="color: #888;">MATCH THE FALLING LAST ROW!</p>
        <button class="btn-start" id="startBtn">PAY 50 & START</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
        authDomain: "hfc-academy.firebaseapp.com",
        projectId: "hfc-academy",
        storageBucket: "hfc-academy.firebasestorage.app",
        messagingSenderId: "84006497196",
        appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let userData = null;
    let isPlaying = false;
    let gridSymbols = [];
    let projectiles = [];
    let currentAmmo = null;
    const colors = ['#64ffda', '#bc13fe', '#3d5afe', '#ff4d4d', '#ffd700', '#ff00ff'];

    const hfcData = [
        { l: 'A', s: '+' }, { l: 'B', s: '[]' }, { l: 'C', s: '©' }, { l: 'D', s: '÷' },
        { l: 'E', s: '=' }, { l: 'F', s: '_' }, { l: 'G', s: '>' }, { l: 'H', s: '|' },
        { l: 'I', s: '!' }, { l: 'J', s: '#' }, { l: 'K', s: ':' }, { l: 'L', s: '<' },
        { l: 'M', s: '*' }, { l: 'N', s: '°' }, { l: 'O', s: '()' }, { l: 'P', s: '¶' },
        { l: 'Q', s: '?' }, { l: 'R', s: '®' }, { l: 'S', s: '$' }, { l: 'T', s: '™' },
        { l: 'U', s: "'" }, { l: 'V', s: '^' }, { l: 'W', s: '&' }, { l: 'X', s: '`' },
        { l: 'Y', s: '~' }, { l: 'Z', s: '℅' }
    ];

    onAuthStateChanged(auth, u => {
        if(u) {
            onSnapshot(doc(db, "users", u.uid), s => {
                userData = s.data();
                document.getElementById('userRank').innerText = userData.rank.toUpperCase();
                document.getElementById('userCoins').innerText = userData.coins;
            });
        }
    });

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    document.getElementById('startBtn').onclick = async () => {
        if(!userData || userData.coins < 50) return alert("VAULT LOCKED: NEED 50 COINS");
        try {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { coins: increment(-50) });
            initGame();
        } catch (e) { location.reload(); }
    };

    function initGame() {
        isPlaying = true;
        gridSymbols = [];
        projectiles = [];
        
        const rows = 5; 
        const cols = Math.floor(canvas.width / 70);
        const padding = (canvas.width - (cols * 70)) / 2;

        for(let r = 0; r < rows; r++) {
            for(let c = 0; c < cols; c++) {
                gridSymbols.push({
                    x: padding + c * 70 + 35,
                    targetY: r * 75 + 150, // Final position
                    y: (r === rows - 1) ? -100 : r * 75 + 150, // Last row starts from top
                    data: hfcData[Math.floor(Math.random() * hfcData.length)],
                    color: colors[Math.floor(Math.random() * colors.length)],
                    isLastRow: r === rows - 1,
                    active: true
                });
            }
        }
        
        setNewAmmo();
        document.getElementById('menu-overlay').style.display = 'none';
        animate();
    }

    function setNewAmmo() {
        const activeTargets = gridSymbols.filter(t => t.active);
        if(activeTargets.length === 0) return gameOver("MISSION COMPLETE!");
        currentAmmo = activeTargets[Math.floor(Math.random() * activeTargets.length)].data;
    }

    function gameOver(reason) {
        isPlaying = false;
        document.getElementById('msg').innerText = reason;
        document.getElementById('menu-overlay').style.display = 'flex';
    }

    canvas.addEventListener('mousedown', (e) => {
        if (!isPlaying || projectiles.length > 0) return;
        const angle = Math.atan2(e.clientY - (canvas.height - 80), e.clientX - (canvas.width / 2));
        projectiles.push({
            x: canvas.width / 2, y: canvas.height - 80,
            vx: Math.cos(angle) * 20, vy: Math.sin(angle) * 20,
            data: currentAmmo,
            color: colors[Math.floor(Math.random() * colors.length)]
        });
    });

    function animate() {
        if (!isPlaying) return;
        ctx.fillStyle = 'rgba(3, 7, 18, 0.2)'; // Motion blur effect
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        gridSymbols.forEach(t => {
            if(!t.active) return;

            // Last Row Animation: Baar baar upar se niche aana
            if(t.isLastRow) {
                t.y += 3; // Speed of falling
                if(t.y > t.targetY) t.y = -50; // Reset to top when passes its line
            }

            // Glow effect
            ctx.shadowBlur = 15;
            ctx.shadowColor = t.color;
            
            ctx.beginPath();
            ctx.arc(t.x, t.y, 30, 0, Math.PI * 2);
            ctx.strokeStyle = t.color;
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.shadowBlur = 0; // Reset shadow for text
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(t.data.s, t.x, t.y + 8);
        });

        // Shooter Ammo
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 50px Arial';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#fff';
        ctx.fillText(currentAmmo.l, canvas.width/2, canvas.height - 35);
        ctx.shadowBlur = 0;

        projectiles.forEach((p, pi) => {
            p.x += p.vx; p.y += p.vy;
            
            ctx.beginPath();
            ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();

            if(p.x < 0 || p.x > canvas.width) p.vx *= -1;

            gridSymbols.forEach(async (t) => {
                if(!t.active) return;
                const dist = Math.hypot(p.x - t.x, p.y - t.y);
                if(dist < 50) {
                    if(p.data.l === t.data.l) {
                        t.active = false;
                        projectiles.splice(pi, 1);
                        await updateDoc(doc(db, "users", auth.currentUser.uid), { coins: increment(2) });
                        setNewAmmo();
                    } else {
                        gameOver("DECRYPTION ERROR");
                    }
                }
            });

            if(p.y < 0) projectiles.splice(pi, 1);
        });

        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
