<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC Game 9 - Learn & Mine</title>
    <style>
        :root { --neon: #64ffda; --bg: #000; --gold: #ffd700; --danger: #ff4d4d; --glass: rgba(255, 255, 255, 0.05); }
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); 
            background-image: radial-gradient(circle at top, #112240 0%, #000 90%);
            color: white; margin: 0; padding: 15px; text-align: center; min-height: 100vh;
        }
        .mission-container {
            max-width: 550px; margin: 10px auto; background: var(--glass);
            border: 2px solid var(--neon); border-radius: 25px; padding: 25px;
            backdrop-filter: blur(15px); box-sizing: border-box;
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 12px; border: 1px solid #333; }
        .val { color: var(--gold); font-weight: bold; display: block; }
        
        .question-box { background: #000; padding: 20px; border-radius: 15px; border: 1px solid var(--neon); margin-bottom: 20px; min-height: 80px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .opt-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { background: var(--glass); border: 1px solid #444; color: white; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .opt-btn:hover { border-color: var(--neon); background: rgba(100, 255, 218, 0.1); }

        .progress-wrapper { height: 10px; background: #111; border-radius: 5px; margin-top: 20px; overflow: hidden; border: 1px solid #333; }
        .progress-bar { height: 100%; background: var(--neon); width: 0%; transition: 0.4s; box-shadow: 0 0 10px var(--neon); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .btn-main { background: var(--neon); color: #000; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

<div class="mission-container">
    <h2 style="color: var(--neon); margin-top: 0;">MINING MODULE 09</h2>
    
    <div class="stat-grid">
        <div class="stat-card"><span style="font-size: 10px;">VAULT</span><span id="u-coins" class="val">--</span></div>
        <div class="stat-card"><span style="font-size: 10px;">PROGRESS</span><span id="u-prog" class="val">0 / 15</span></div>
    </div>

    <div id="game-core">
        <div id="q-text" class="question-box">System Initializing...</div>
        <div class="opt-grid" id="options"></div>
        <div class="progress-wrapper"><div id="p-bar" class="progress-bar"></div></div>
    </div>
</div>

<div id="start-overlay" class="overlay">
    <div style="border: 1px solid var(--gold); padding: 30px; border-radius: 20px; background: rgba(255,215,0,0.05);">
        <h3 style="color: var(--gold);">MINING AUTHORIZATION</h3>
        <p>Fee: 5 Coins | Reward: 20 Coins</p>
        <p style="font-size: 12px; color: #888;">Requirement: 15 Correct Answers</p>
        <button class="btn-main" onclick="startMission()">INITIALIZE (5 COINS)</button>
    </div>
</div>

<script type="module">
    import { db, auth } from "./firebase-config.js";
    import { doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userDoc = null;
    let score = 0;
    const target = 15;

    const database = [
        { q: "HFC 1 Coin ki value kya hai?", a: ["0.02 PKR", "0.05 PKR", "1 PKR"], c: 0 },
        { q: "Withdrawal process kitnay hours leta hai?", a: ["12-24h", "1h", "Instant"], c: 0 },
        { q: "Admin contact kahan milay ga?", a: ["Inbox", "Profile", "Settings"], c: 0 },
        { q: "Learn & Earn ka kia matlab hai?", a: ["Seekhna aur Kamana", "Sirf Kamana", "Time Pass"], c: 0 },
        { q: "HFC rank 'Elite' kab milti hai?", a: ["1000 XP", "5000 XP", "500 XP"], c: 1 }
    ];

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userDoc = doc(db, "users", user.uid);
            const snap = await getDoc(userDoc);
            if (snap.exists()) {
                document.getElementById('u-coins').innerText = snap.data().coins;
            }
        } else { window.location.href = "auth.html"; }
    });

    window.startMission = async () => {
        const snap = await getDoc(userDoc);
        const currentCoins = snap.data().coins || 0;

        if (currentCoins < 5) {
            alert("INSUFFICIENT COINS: You need at least 5 coins.");
            return;
        }

        try {
            // Sync with DB (Deduct Fee)
            await updateDoc(userDoc, { coins: increment(-5) });
            document.getElementById('u-coins').innerText = currentCoins - 5;
            document.getElementById('start-overlay').style.display = 'none';
            renderNext();
        } catch (e) { alert("SYNC ERROR"); }
    };

    function renderNext() {
        const q = database[Math.floor(Math.random() * database.length)];
        document.getElementById('q-text').innerText = q.q;
        const btnContainer = document.getElementById('options');
        btnContainer.innerHTML = '';

        q.a.forEach((opt, i) => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = opt;
            b.onclick = () => check(i, q.c);
            btnContainer.appendChild(b);
        });
    }

    async function check(sel, cor) {
        if (sel === cor) {
            score++;
            document.getElementById('u-prog').innerText = `${score} / ${target}`;
            document.getElementById('p-bar').style.width = `${(score / target) * 100}%`;

            if (score >= target) {
                // Final Sync with DB (Add Reward)
                await updateDoc(userDoc, { coins: increment(20), score: increment(30) });
                alert("MISSION SUCCESS: 20 COINS ADDED TO VAULT");
                location.reload();
            } else { renderNext(); }
        } else {
            alert("WRONG DATA: Recalibrating...");
            renderNext();
        }
    }
</script>
</body>
</html>
