<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFC - 8K Row Shifter</title>
    <style>
        :root { 
            --neon: #64ffda; --bg: #020617; --gold: #fbbf24; 
            --pink: #f472b6; --blue: #38bdf8; 
        }
        body { 
            margin: 0; overflow: hidden; background: var(--bg);
            font-family: 'Inter', system-ui, sans-serif;
            color: white;
        }
        /* 8K UI Styling */
        .header { 
            position: absolute; top: 15px; width: 90%; left: 5%;
            display: flex; justify-content: space-between; z-index: 10;
            background: rgba(15, 23, 42, 0.8); padding: 15px;
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .stat-label { font-size: 10px; color: #94a3b8; display: block; margin-bottom: 2px;}
        .stat-value { font-weight: 800; font-size: 14px; letter-spacing: 1px; }

        #menu-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle, #0f172a 0%, #020617 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .btn-start { 
            padding: 20px 50px; background: linear-gradient(135deg, #64ffda, #38bdf8);
            color: #020617; border: none; border-radius: 50px; font-weight: 900;
            cursor: pointer; font-size: 1.2rem; transition: 0.3s;
            box-shadow: 0 0 30px rgba(100, 255, 218, 0.3);
        }
        .btn-start:hover { transform: scale(1.05); box-shadow: 0 0 50px rgba(100, 255, 218, 0.5); }
    </style>
</head>
<body>

    <div class="header">
        <div><span class="stat-label">OPERATIVE</span><span id="userRank" class="stat-value" style="color:var(--neon)">---</span></div>
        <div><span class="stat-label">VAULT BALANCE</span><span id="userCoins" class="stat-value" style="color:var(--gold)">0</span></div>
    </div>

    <div id="menu-overlay">
        <h1 style="font-size: 3.5rem; margin: 0; background: linear-gradient(to right, #64ffda, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SHIFT SHOOTER</h1>
        <p style="color: #64748b; margin-bottom: 30px;">8K ULTRA RESOLUTION INTERFACE</p>
        <button class="btn-start" id="startBtn">PAY 50 & START</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIT9JgQ8t044EbgeGSGWNfh-CgNrWajN8",
        authDomain: "hfc-academy.firebaseapp.com",
        projectId: "hfc-academy",
        storageBucket: "hfc-academy.firebasestorage.app",
        messagingSenderId: "84006497196",
        appId: "1:84006497196:web:be0d33ae2db19dd77ae809"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let userData = null;
    let isPlaying = false;
    let gridRows = []; // Array of arrays
    let projectile = null;
    let currentAmmo = null;

    const hfcData = [
        { l: 'A', s: '+' }, { l: 'B', s: '[]' }, { l: 'C', s: '©' }, { l: 'D', s: '÷' },
        { l: 'E', s: '=' }, { l: 'F', s: '_' }, { l: 'G', s: '>' }, { l: 'H', s: '|' },
        { l: 'I', s: '!' }, { l: 'J', s: '#' }, { l: 'K', s: ':' }, { l: 'L', s: '<' },
        { l: 'M', s: '*' }, { l: 'N', s: '°' }, { l: 'O', s: '()' }, { l: 'P', s: '¶' },
        { l: 'Q', s: '?' }, { l: 'R', s: '®' }, { l: 'S', s: '$' }, { l: 'T', s: '™' },
        { l: 'U', s: "'" }, { l: 'V', s: '^' }, { l: 'W', s: '&' }, { l: 'X', s: '`' },
        { l: 'Y', s: '~' }, { l: 'Z', s: '℅' }
    ];

    onAuthStateChanged(auth, u => {
        if(u) {
            onSnapshot(doc(db, "users", u.uid), s => {
                userData = s.data();
                document.getElementById('userRank').innerText = userData.rank.toUpperCase();
                document.getElementById('userCoins').innerText = userData.coins;
            });
        }
    });

    function resize() {
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
    }
    window.addEventListener('resize', resize);
    resize();

    document.getElementById('startBtn').onclick = async () => {
        if(!userData || userData.coins < 50) return alert("VAULT ACCESS DENIED");
        try {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { coins: increment(-50) });
            initGame();
        } catch (e) { location.reload(); }
    };

    function initGame() {
        isPlaying = true;
        gridRows = [];
        const numRows = 5;
        for(let i = 0; i < numRows; i++) {
            gridRows.push(generateRow(i));
        }
        setNewAmmo();
        document.getElementById('menu-overlay').style.display = 'none';
        animate();
    }

    function generateRow(rowIndex) {
        const cols = 5;
        const row = [];
        const spacing = window.innerWidth / (cols + 1);
        for(let i = 0; i < cols; i++) {
            row.push({
                x: spacing * (i + 1),
                y: 120 + (rowIndex * 80),
                data: hfcData[Math.floor(Math.random() * hfcData.length)],
                color: rowIndex === 4 ? '#64ffda' : '#1e293b' // Bottom row highlighted
            });
        }
        return row;
    }

    function setNewAmmo() {
        // Guaranteed Match Logic: Ammo will be one of the symbols in the bottom-most row
        const bottomRow = gridRows[gridRows.length - 1];
        const randomTarget = bottomRow[Math.floor(Math.random() * bottomRow.length)];
        currentAmmo = randomTarget.data;
    }

    canvas.addEventListener('mousedown', (e) => {
        if (!isPlaying || projectile) return;
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        const angle = Math.atan2(mouseY - (window.innerHeight - 100), mouseX - (window.innerWidth / 2));
        
        projectile = {
            x: window.innerWidth / 2,
            y: window.innerHeight - 100,
            vx: Math.cos(angle) * 25,
            vy: Math.sin(angle) * 25,
            data: currentAmmo
        };
    });

    async function shiftGrid() {
        // Remove bottom row
        gridRows.pop();
        // Shift all remaining rows down
        gridRows.forEach(row => {
            row.forEach(t => t.y += 80);
        });
        // Add new row at top
        gridRows.unshift(generateRow(0));
        // Reset top row Y
        gridRows[0].forEach(t => t.y = 120);
        
        await updateDoc(doc(db, "users", auth.currentUser.uid), { coins: increment(2) });
        setNewAmmo();
    }

    function animate() {
        if (!isPlaying) return;
        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

        // Draw Rows
        gridRows.forEach((row, rowIndex) => {
            const isBottom = rowIndex === gridRows.length - 1;
            row.forEach(t => {
                ctx.beginPath();
                ctx.arc(t.x, t.y, 25, 0, Math.PI * 2);
                ctx.strokeStyle = isBottom ? '#64ffda' : 'rgba(100, 255, 218, 0.1)';
                ctx.lineWidth = isBottom ? 3 : 1;
                ctx.stroke();
                
                ctx.fillStyle = isBottom ? '#fff' : '#334155';
                ctx.font = '800 18px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(t.data.s, t.x, t.y + 7);
            });
        });

        // Current Ammo
        ctx.fillStyle = '#64ffda';
        ctx.font = '900 60px Inter';
        ctx.fillText(currentAmmo.l, window.innerWidth/2, window.innerHeight - 40);

        // Projectile Logic
        if(projectile) {
            projectile.x += projectile.vx;
            projectile.y += projectile.vy;

            ctx.beginPath();
            ctx.arc(projectile.x, projectile.y, 15, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.shadowBlur = 20; ctx.shadowColor = '#fff';
            ctx.fill();
            ctx.shadowBlur = 0;

            if(projectile.x < 0 || projectile.x > window.innerWidth) projectile.vx *= -1;

            // Check collision with BOTTOM row ONLY
            const bottomRow = gridRows[gridRows.length - 1];
            bottomRow.forEach((t, i) => {
                const dist = Math.hypot(projectile.x - t.x, projectile.y - t.y);
                if(dist < 40) {
                    if(projectile.data.l === t.data.l) {
                        projectile = null;
                        shiftGrid();
                    } else {
                        isPlaying = false;
                        document.getElementById('menu-overlay').style.display = 'flex';
                    }
                }
            });

            if(projectile && (projectile.y < 0 || projectile.y > window.innerHeight)) projectile = null;
        }

        requestAnimationFrame(animate);
    }
</script>
</body>
</html>
